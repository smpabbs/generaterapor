<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Rapor Terpadu (V83 - Fixed ILA Summary)</title>
    
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">

    <style>
        /* --- GLOBAL STYLE --- */
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, sans-serif; background-color: #2c3e50; overflow: hidden; display: flex; height: 100vh; }
        
        /* LANDING PAGE */
        #landing-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1e3a8a 0%, #d97706 100%); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; }
        .landing-card { background: rgba(255, 255, 255, 0.15); padding: 50px; border-radius: 20px; backdrop-filter: blur(10px); box-shadow: 0 15px 35px rgba(0,0,0,0.4); text-align: center; }
        .landing-btn { display: block; width: 320px; padding: 18px; margin: 20px auto; font-size: 18px; font-weight: bold; border: none; border-radius: 50px; cursor: pointer; transition: transform 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .btn-dinas { background: #fff; color: #1e3a8a; } .btn-ila { background: #d97706; color: #fff; }
        .landing-btn:hover { transform: translateY(-3px); }

        /* APP LAYOUT */
        .app-container { display: none; height: 100vh; width: 100%; } 
        .sidebar { width: 340px; background: #fff; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; padding: 20px; overflow-y: auto; z-index: 100; transition: margin-left 0.3s ease; flex-shrink: 0; }
        .sidebar.closed { margin-left: -340px; }
        
        .sidebar-header { display: flex; flex-direction: column; margin-bottom: 15px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .header-actions { display: flex; gap: 5px; }
        
        .home-btn { background: #64748b; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .reset-btn { background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 11px; }
        
        /* INPUTS */
        fieldset { border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 10px; padding: 10px; background: #f8fafc; }
        legend { font-size: 10px; font-weight: bold; text-transform: uppercase; padding: 0 5px; }
        .leg-dinas { color: #1e3a8a; } .leg-ila { color: #d97706; }
        .input-group { margin-bottom: 8px; display: flex; flex-direction: column; }
        .input-group label { font-size: 11px; font-weight: 600; margin-bottom: 2px; color: #475569; }
        input[type="text"], select { padding: 6px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 12px; width: 100%; box-sizing: border-box; }
        
        /* SIGNATURE CONTROLS - PERBAIKAN */
        .signature-section { margin-top: 10px; padding: 10px; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0; }
        .sig-preview-container { 
            width: 100%; 
            height: 120px; 
            border: 1px dashed #cbd5e1; 
            border-radius: 4px; 
            margin-bottom: 10px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: white;
            position: relative;
            overflow: hidden;
            touch-action: none;
        }
        .sig-preview { 
            max-width: 100%; 
            max-height: 100%; 
            transition: transform 0.2s;
            cursor: move;
            transform-origin: center center;
            touch-action: none;
        }
        .sig-controls { display: flex; flex-direction: column; gap: 8px; }
        .sig-row { display: flex; gap: 8px; align-items: center; }
        .sig-btn { flex: 1; padding: 6px; font-size: 11px; cursor: pointer; border: 1px solid #ccc; background: #fff; border-radius: 4px; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .sig-btn:hover { background: #f1f5f9; }
        .zoom-controls { display: flex; align-items: center; gap: 8px; margin-top: 5px; }
        .zoom-btn { width: 28px; height: 28px; border: 1px solid #cbd5e1; background: white; border-radius: 4px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; }
        .zoom-btn:hover { background: #f1f5f9; }
        .zoom-slider { flex: 1; }
        .zoom-value { min-width: 40px; text-align: center; font-size: 11px; font-weight: 600; color: #475569; }
        
        /* ACTION BUTTONS */
        button.action-btn { width: 100%; padding: 12px; margin-top: 8px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: white; font-size: 13px; display: flex; align-items: center; justify-content: center; gap: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: 0.2s; }
        button.action-btn:hover { filter: brightness(1.1); transform: translateY(-1px); }
        button.action-btn:disabled { background: #ccc !important; cursor: not-allowed; }
        .bg-blue { background: #1e3a8a; } .bg-green { background: #10b981; } .bg-orange { background: #f59e0b; }
        
        /* PROGRESS BAR */
        .progress-container { margin-bottom: 15px; display: none; background: #f1f5f9; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; }
        .progress-bar { width: 100%; height: 10px; background: #cbd5e1; border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; background: #2563eb; transition: width 0.3s ease-out; background-image: linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent); background-size: 1rem 1rem; animation: progress-stripes 1s linear infinite; }
        .progress-text { font-size: 11px; text-align: center; margin-top: 5px; color: #334155; font-weight: 600; }
        @keyframes progress-stripes { from { background-position: 1rem 0; } to { background-position: 0 0; } }

        /* MAIN PREVIEW AREA */
        .main-wrapper { flex: 1; display: flex; flex-direction: column; height: 100vh; overflow: hidden; background: #525659; position: relative; }
        .main-content { 
            flex: 1; overflow-y: auto; padding: 40px; 
            display: flex; flex-direction: column; align-items: center; 
            scroll-behavior: smooth; padding-bottom: 80px; 
            -webkit-overflow-scrolling: touch;
        }

        /* TOOLBAR NAVIGASI */
        .preview-toolbar {
            height: 60px; background: #34495e; color: white; 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 20px; box-shadow: 0 -2px 10px rgba(0,0,0,0.3); 
            z-index: 50; flex-shrink: 0;
        }
        .toolbar-left { display: flex; align-items: center; gap: 15px; }
        .toggle-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
        .view-controls { display: flex; background: #2c3e50; border-radius: 5px; padding: 3px; }
        .view-btn { background: none; border: none; color: #95a5a6; padding: 6px 12px; cursor: pointer; font-size: 12px; font-weight: bold; border-radius: 4px; transition: 0.2s; }
        .view-btn.active { background: #1e3a8a; color: white; }
        .nav-controls { display: flex; align-items: center; gap: 10px; display: none; }
        #studentSelector { padding: 6px; border-radius: 4px; font-size: 12px; max-width: 250px; background: #fff; color: #333; border: none;}
        .nav-btn { background: #1e3a8a; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold; }
        
        /* --- RAPOR SHEETS --- */
        .sheet {
            background: white; width: 210mm; height: 297mm;
            margin-bottom: 40px; box-sizing: border-box;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; position: relative; overflow: hidden; flex-shrink: 0;
        }
        .content-body { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

        /* DINAS STYLE */
        .sheet-dinas { padding: 10mm 10mm 20mm 10mm; font-family: 'Times New Roman', Times, serif; color: black; }
        .dinas-header table { width: 100%; border-collapse: collapse; font-size: 11pt; table-layout: fixed; }
        .dinas-header td { padding: 2px 0; vertical-align: top; border: none; word-wrap: break-word; }
        .header-separator { border-bottom: 2px solid black; margin-bottom: 15px; margin-top: 5px; }
        .dinas-title { font-size: 14pt; margin: 10px 0 5px 0; text-align: center; font-weight: bold; text-transform: uppercase; }
        .dinas-sub { font-size: 12pt; margin: 15px 0 5px 0; font-weight: bold; display: inline-block; }
        .dinas-table { width: 100%; border-collapse: collapse; font-size: 11pt; margin-bottom: 5px; }
        .dinas-table th, .dinas-table td { border: 1px solid black; padding: 4px 6px; vertical-align: middle; }
        .dinas-table th { background: #f2f2f2; font-weight: bold; text-align: center; }
        .cell-center { text-align: center !important; } .cell-left { text-align: left !important; } .cell-justify { text-align: justify !important; }
        .dinas-footer { position: absolute; bottom: 10mm; left: 10mm; right: 10mm; height: 10mm; border-top: 2px solid black; padding-top: 5px; font-size: 10pt; display: flex; justify-content: space-between; align-items: center; }
        .catatan-box { text-align: justify; width: 100%; border: 1px solid black; padding: 10px; min-height: 80px; box-sizing: border-box; font-size: 11pt; margin-bottom: 10px; }
        .cell-leftextra { text-align: justify !important; } .cell-justify { text-align: justify !important; }
        .signature-container { margin-top: 20px; }
        .signature-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .sig-box { text-align: center; position: relative; }
        .sig-box-center { grid-column: 1 / -1; text-align: center; margin-top: 30px; position: relative; }
        .sig-box p, .sig-box-center p { margin: 4px 0; line-height: 1.2; } 
        .space-sign { height: 50px; width: 100%; position: relative; } 
        
        /* ILA STYLE */
        .sheet-ila { padding: 40px 50px; font-family: 'Inter', sans-serif; color: #000; }
        .ila-h1 { font-family: 'Poppins', sans-serif; font-weight: 800; font-size: 20px; text-transform: uppercase; letter-spacing: 0.5px; color: #1e3a8a; margin: 0 0 5px 0; text-align: center; }
        
        /* PERBAIKAN SPASI HALAMAN 1 */
        .scoring-card { margin-bottom: 8px; }
        .scoring-card + .ila-dim-title { margin-top: 2px; }

        .ila-dim-title { font-family: 'Poppins', sans-serif; font-weight: 700; font-size: 16px; color: #d97706; margin-top: 15px; margin-bottom: 5px; border-bottom: 2px solid #d97706; display: inline-block; padding-bottom: 2px; text-transform: uppercase; }
        .ila-val-title { font-family: 'Inter', sans-serif; font-weight: 600; font-size: 13px; color: #1f2937; margin-top: 10px; margin-bottom: 5px; padding-left: 5px; }
        .ila-info-container { display: flex; justify-content: space-between; margin-bottom: 15px; border-bottom: 2px solid #000; padding-bottom: 10px; }
        .ila-info-col { width: 48%; }
        .ila-info-table { width: 100%; font-size: 13px; font-weight: 500; border-collapse: collapse; }
        .ila-info-table td { padding: 2px 0; vertical-align: top; }
        .ila-info-table .val { font-weight: 700; color: #000; }
        
        .scoring-title { font-size: 11px; font-weight: 700; text-transform: uppercase; color: #1e3a8a; margin-bottom: 5px; border-bottom: 1px solid #ccc; padding-bottom: 2px; text-align: center; }
        .scoring-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; }
        .score-box { border: 1px solid #ccc; border-radius: 6px; overflow: hidden; display: flex; flex-direction: column; }
        .sb-head { background: #1e3a8a; color: white; text-align: center; font-weight: bold; padding: 3px; font-size: 13px; }
        .sb-body { padding: 5px; text-align: center; font-size: 8px; line-height: 1.2; flex: 1; display: flex; flex-direction: column; justify-content: center; background: #fff; }
        .sb-label { font-weight: 800; color: #d97706; margin-bottom: 2px; display: block; font-size: 9px; }
        
        .ila-table-container { margin-bottom: 10px; }
        .ila-table { width: 100%; border-collapse: collapse; font-size: 11px; border: 1px solid #000; }
        .ila-table th { background-color: #1e3a8a; color: white; padding: 6px; text-align: center; font-weight: 600; text-transform: uppercase; font-size: 10px; border: 1px solid #000; vertical-align: middle; }
        .ila-table td { border: 1px solid #000; padding: 5px 8px; vertical-align: middle; }
        .ila-table .col-score { width: 35px; text-align: center; font-weight: bold; font-size: 12px; vertical-align: middle; }
        .ila-table tr.row-category td { background-color: #f3f4f6; font-weight: 700; color: #1e3a8a; text-transform: uppercase; font-size: 10px; padding: 5px 10px; border: 1px solid #000; }
        .indicator-text { text-align: justify; line-height: 1.3; }

        /* RESUME TABLE */
        .resume-page-header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .resume-title-main { font-family: 'Poppins', sans-serif; font-size: 18px; font-weight: 800; color: #1e3a8a; text-transform: uppercase; letter-spacing: 1px; }
        .resume-section { margin-bottom: 25px; }
        .resume-dim-header { background-color: #e5e7eb; color: #1e3a8a; padding: 8px 10px; font-family: 'Poppins', sans-serif; font-weight: 700; font-size: 14px; border-radius: 4px 4px 0 0; border: 1px solid #000; border-bottom: none; text-transform: uppercase; }
        .resume-table { width: 100%; border-collapse: collapse; font-size: 11px; font-family: 'Inter', sans-serif; }
        .resume-table th, .resume-table td { border: 1px solid #000; padding: 8px 10px; vertical-align: middle; }
        .resume-table th { background-color: #1e3a8a; color: white; font-weight: 600; text-align: center; text-transform: uppercase; font-size: 10px; }
        .resume-table td.center { text-align: center; }
        .resume-table td.bold { font-weight: 700; }
        .resume-desc { text-align: justify; font-size: 10px; line-height: 1.3; }

        .ila-sig-section { margin-top: 40px; display: flex; justify-content: flex-end; font-size: 12px; font-weight: 500; }
        .ila-sig-box { text-align: center; width: 220px; position: relative; }
        .ila-sig-box p { margin: 4px 0; line-height: 1.2; } 
        
        .toggle-text { cursor: pointer; } .is-crossed { text-decoration: line-through; color: #555; }

        /* --- DRAGGABLE SIGNATURE STYLE --- */
        .draggable-sig { 
            position: absolute; 
            cursor: move; 
            z-index: 10; 
            border: 1px dashed transparent; 
            transition: border 0.2s, transform 0.2s;
            transform-origin: center center;
            touch-action: none;
            user-select: none;
        }
        .draggable-sig:hover { border: 1px dashed #2563eb; }

        /* FLOATING DOWNLOAD BUTTON */
        .floating-download-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
            cursor: pointer;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            overflow: hidden;
        }
        
        .floating-download-btn:hover {
            transform: scale(1.1) translateY(-5px);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.6);
        }
        
        .floating-download-btn:active {
            transform: scale(0.95);
        }
        
        .floating-download-btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, transparent, rgba(255,255,255,0.2), transparent);
            transform: translateX(-100%);
        }
        
        .floating-download-btn.loading::after {
            animation: shimmer 1.5s infinite;
        }
        
        .floating-download-btn .btn-text {
            position: absolute;
            top: -35px;
            right: 0;
            background: #1e293b;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .floating-download-btn:hover .btn-text {
            opacity: 1;
            transform: translateY(0);
        }
        
        @keyframes shimmer {
            100% { transform: translateX(100%); }
        }
        
        .floating-download-btn.pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
        
        /* Untuk mode ILA (warna oranye) */
        .floating-download-btn.ila-mode {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
        }
        
        .floating-download-btn.ila-mode:hover {
            box-shadow: 0 10px 25px rgba(245, 158, 11, 0.6);
        }
        
        .floating-download-btn.ila-mode.pulse {
            animation: pulse-orange 2s infinite;
        }
        
        @keyframes pulse-orange {
            0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(245, 158, 11, 0); }
            100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
        }

        /* Hidden Processing Container */
        #hidden-processing { position: fixed; left: -9999px; top: 0; width: 210mm; }
    </style>
</head>
<body>

    <div id="landing-page">
        <div class="landing-card">
            <h1 style="margin-bottom: 10px;">SISTEM RAPOR TERPADU</h1>
            <h3 style="margin-bottom: 40px; opacity: 0.9; font-weight: normal;">SMP ABBS SURAKARTA</h3>
            <button class="landing-btn btn-dinas" onclick="switchApp('dinas')">üìò RAPOR DINAS</button>
            <button class="landing-btn btn-ila" onclick="switchApp('ila')">üìô RAPOR ILA (Leadership)</button>
        </div>
    </div>

    <div id="app-dinas" class="app-container">
        <div class="sidebar" id="sidebar-dinas">
            <div class="sidebar-header">
                <div class="header-top"><h3 style="margin:0; color:#1e3a8a;">Rapor Dinas</h3></div>
                <div class="header-actions">
                    <button class="home-btn" onclick="goHome()">üè† Menu</button>
                    <button class="reset-btn" onclick="resetApp()">üîÑ Reset Data</button>
                </div>
            </div>
            <fieldset>
                <legend class="leg-dinas">üìÇ File Leger</legend>
                <input type="file" id="fileDinas" accept=".xlsx, .xls">
                <select id="sheetDinas" disabled onchange="autoFillClass('dinas')"><option value="">-- Upload Dulu --</option></select>
            </fieldset>
            <fieldset>
                <legend class="leg-dinas">üè´ Sekolah & Info</legend>
                <div class="input-group"><label>Sekolah</label><input type="text" id="dinasSekolah" oninput="saveData('dinas')" value="SMP ABBS Surakarta"></div>
                <div class="input-group"><label>Alamat</label><input type="text" id="dinasAlamat" oninput="saveData('dinas')" value="Jl. Tarumanegara III, Banyuanyar, Banjarsari, Surakarta"></div>
                <div class="input-group"><label>Kepala Sekolah</label><input type="text" id="dinasKepsek" oninput="saveData('dinas')" value="Tri Wijayanti, M.Pd"></div>
                <div class="input-group"><label>Kelas</label><input type="text" id="dinasKelas"></div>
                <div class="input-group"><label>Fase</label><input type="text" id="dinasFase" oninput="saveData('dinas')" value="D"></div>
                <div class="input-group"><label>Semester</label><select id="dinasSem" onchange="saveData('dinas')"><option value="1 (Ganjil)">1 (Ganjil)</option><option value="2 (Genap)">2 (Genap)</option></select></div>
                <div class="input-group"><label>Tahun Ajaran</label><select id="dinasThn" onchange="saveData('dinas')"><option>2025/2026</option><option>2026/2027</option></select></div>
                <div class="input-group"><label>Tgl Rapor</label><input type="text" id="dinasTgl" oninput="saveData('dinas')" value="Surakarta, 20 Desember 2025"></div>
            </fieldset>
            
            <!-- WALI KELAS DAN TTD WALI KELAS -->
            <fieldset>
                <legend class="leg-dinas">‚úçÔ∏è Wali Kelas & Tanda Tangan</legend>
                <div class="input-group"><label>Nama Wali Kelas</label><input type="text" id="dinasWali" oninput="saveData('dinas')" value="Febriyono S. Pd, M.Bg"></div>
                <div class="input-group"><label>NIP Wali Kelas</label><input type="text" id="dinasNIP" oninput="saveData('dinas')" value="-"></div>
                
                <div class="signature-section">
                    <div class="input-group"><label>Upload TTD Wali Kelas (PNG/JPG)</label><input type="file" id="sigFileDinas" accept="image/png, image/jpeg" onchange="handleSigUpload(event, 'dinas')"></div>
                    <div class="sig-preview-container" id="sigPreviewDinas">
                        <div style="color: #94a3b8; font-size: 12px;">Upload tanda tangan wali kelas</div>
                    </div>
                    <div class="sig-controls">
                        <div class="sig-row">
                            <button class="sig-btn" onclick="clearSig('dinas')">‚ùå Hapus</button>
                            <button class="sig-btn" onclick="resetSigPos('dinas')">üìç Reset Posisi</button>
                            <button class="sig-btn" onclick="resetSigSize('dinas')">‚Ü∫ Reset Ukuran</button>
                        </div>
                        <div class="zoom-controls">
                            <button class="zoom-btn" onclick="adjustSigZoom('dinas', -0.1)">‚àí</button>
                            <input type="range" class="zoom-slider" id="zoomSliderDinas" min="10" max="200" value="100" 
                                   oninput="updateSigZoom('dinas', this.value, true)" 
                                   onmouseup="delayedPreviewUpdate('dinas', true)">
                            <button class="zoom-btn" onclick="adjustSigZoom('dinas', 0.1)">Ôºã</button>
                            <div class="zoom-value" id="zoomValueDinas">100%</div>
                        </div>
                    </div>
                </div>
            </fieldset>
            
            <!-- KEPALA SEKOLAH DAN TTD KEPALA SEKOLAH -->
            <fieldset>
                <legend class="leg-dinas">‚úçÔ∏è Kepala Sekolah & Tanda Tangan</legend>
                <div class="input-group"><label>Nama Kepala Sekolah</label><input type="text" id="dinasKepsek" oninput="saveData('dinas')" value="Tri Wijayanti, M.Pd"></div>
                <div class="input-group"><label>NIP Kepala Sekolah</label><input type="text" id="dinasNIPKepsek" oninput="saveData('dinas')" value="-"></div>
                
                <div class="signature-section">
                    <div class="input-group"><label>Upload TTD Kepala Sekolah (PNG/JPG)</label><input type="file" id="sigFileKepsek" accept="image/png, image/jpeg" onchange="handleSigUpload(event, 'kepsek')"></div>
                    <div class="sig-preview-container" id="sigPreviewKepsek">
                        <div style="color: #94a3b8; font-size: 12px;">Upload tanda tangan kepala sekolah</div>
                    </div>
                    <div class="sig-controls">
                        <div class="sig-row">
                            <button class="sig-btn" onclick="clearSig('kepsek')">‚ùå Hapus</button>
                            <button class="sig-btn" onclick="resetSigPos('kepsek')">üìç Reset Posisi</button>
                            <button class="sig-btn" onclick="resetSigSize('kepsek')">‚Ü∫ Reset Ukuran</button>
                        </div>
                        <div class="zoom-controls">
                            <button class="zoom-btn" onclick="adjustSigZoom('kepsek', -0.1)">‚àí</button>
                            <input type="range" class="zoom-slider" id="zoomSliderKepsek" min="10" max="200" value="100" 
                                   oninput="updateSigZoom('kepsek', this.value, true)"
                                   onmouseup="delayedPreviewUpdate('dinas', true)">
                            <button class="zoom-btn" onclick="adjustSigZoom('kepsek', 0.1)">Ôºã</button>
                            <div class="zoom-value" id="zoomValueKepsek">100%</div>
                        </div>
                    </div>
                </div>
            </fieldset>
            
            <div id="progDinas" class="progress-container">
                <div class="progress-bar"><div class="progress-fill" id="fillDinas"></div></div>
                <div class="progress-text" id="txtDinas">Processing...</div>
            </div>
            <button class="action-btn bg-blue" onclick="processPreview('dinas')">üëÅÔ∏è Tampilkan Preview</button>
            <button class="action-btn bg-green" onclick="generateBatchPDF('dinas')">üìÑ Download 1 Kelas (PDF)</button>
            <button class="action-btn bg-orange" onclick="generateBatchZIP('dinas')">üì¶ Download Per Siswa (ZIP)</button>
        </div>
        <div class="main-wrapper">
            <div class="preview-toolbar">
                <div class="toolbar-left"><button class="toggle-btn" onclick="toggleSidebar('dinas')">‚ò∞</button><span style="font-weight:bold; font-size:14px; margin-left:10px;">Preview: Dinas</span></div>
                <div class="view-controls"><button id="btnViewAllDinas" class="view-btn active" onclick="setViewMode('all', 'dinas')">üìú Semua</button><button id="btnViewSingleDinas" class="view-btn" onclick="setViewMode('single', 'dinas')">üë§ Per Siswa</button></div>
                <div class="nav-controls" id="navControlsDinas"><button class="nav-btn" onclick="changeStudent(-1, 'dinas')">‚óÄ</button><select id="studentSelectorDinas" onchange="jumpToStudent('dinas')"></select><button class="nav-btn" onclick="changeStudent(1, 'dinas')">‚ñ∂</button></div>
            </div>
            <div class="main-content" id="outputDinas"><div style="color:white; margin-top:50px;"><h3>Silakan Upload Leger Dinas</h3></div></div>
        </div>
    </div>

    <div id="app-ila" class="app-container">
        <div class="sidebar" id="sidebar-ila">
            <div class="sidebar-header">
                <div class="header-top"><h3 style="margin:0; color:#d97706;">Rapor ILA</h3></div>
                <div class="header-actions"><button class="home-btn" onclick="goHome()">üè† Menu</button><button class="reset-btn" onclick="resetApp()">üîÑ Reset</button></div>
            </div>
            <fieldset>
                <legend class="leg-ila">üìÇ File Leger</legend>
                <input type="file" id="fileILA" accept=".xlsx, .xls">
                <select id="sheetILA" disabled onchange="autoFillClass('ila')"><option value="">-- Upload Dulu --</option></select>
            </fieldset>
            <fieldset>
                <legend class="leg-ila">‚öôÔ∏è Info Rapor</legend>
                <div class="input-group"><label>Sekolah</label><input type="text" id="ilaSekolah" oninput="saveData('ila')" value="SMP ABBS Surakarta"></div>
                <div class="input-group"><label>Tanggal</label><input type="text" id="ilaTgl" oninput="saveData('ila')" value="Surakarta, 20 December 2025"></div>
                <div class="input-group"><label>Kelas</label><input type="text" id="ilaKelas"></div>
            </fieldset>
            
            <!-- WALI KELAS DAN TTD WALI KELAS -->
            <fieldset>
                <legend class="leg-ila">‚úçÔ∏è Wali Kelas & Tanda Tangan</legend>
                <div class="input-group"><label>Nama Wali Kelas</label><input type="text" id="ilaWali" oninput="saveData('ila')" value="Febriyono S. Pd, M.Bg"></div>
                
                <div class="signature-section">
                    <div class="input-group"><label>Upload TTD Wali Kelas (PNG/JPG)</label><input type="file" id="sigFileILA" accept="image/png, image/jpeg" onchange="handleSigUpload(event, 'ila')"></div>
                    <div class="sig-preview-container" id="sigPreviewILA">
                        <div style="color: #94a3b8; font-size: 12px;">Upload tanda tangan wali kelas</div>
                    </div>
                    <div class="sig-controls">
                        <div class="sig-row">
                            <button class="sig-btn" onclick="clearSig('ila')">‚ùå Hapus</button>
                            <button class="sig-btn" onclick="resetSigPos('ila')">üìç Reset Posisi</button>
                            <button class="sig-btn" onclick="resetSigSize('ila')">‚Ü∫ Reset Ukuran</button>
                        </div>
                        <div class="zoom-controls">
                            <button class="zoom-btn" onclick="adjustSigZoom('ila', -0.1)">‚àí</button>
                            <input type="range" class="zoom-slider" id="zoomSliderILA" min="10" max="200" value="100" 
                                   oninput="updateSigZoom('ila', this.value, true)"
                                   onmouseup="delayedPreviewUpdate('ila', true)">
                            <button class="zoom-btn" onclick="adjustSigZoom('ila', 0.1)">Ôºã</button>
                            <div class="zoom-value" id="zoomValueILA">100%</div>
                        </div>
                    </div>
                </div>
            </fieldset>
            
            <div id="progILA" class="progress-container">
                <div class="progress-bar"><div class="progress-fill" id="fillILA"></div></div>
                <div class="progress-text" id="txtILA">Processing...</div>
            </div>
            <button class="action-btn bg-blue" onclick="processPreview('ila')">üëÅÔ∏è Tampilkan Preview</button>
            <button class="action-btn bg-green" onclick="generateBatchPDF('ila')">üìÑ Download 1 Kelas (PDF)</button>
            <button class="action-btn bg-orange" onclick="generateBatchZIP('ila')">üì¶ Download Per Siswa (ZIP)</button>
        </div>
        <div class="main-wrapper">
            <div class="preview-toolbar">
                <div class="toolbar-left"><button class="toggle-btn" onclick="toggleSidebar('ila')">‚ò∞</button><span style="font-weight:bold; font-size:14px; margin-left:10px;">Preview: ILA</span></div>
                <div class="view-controls"><button id="btnViewAllILA" class="view-btn active" onclick="setViewMode('all', 'ila')">üìú Semua</button><button id="btnViewSingleILA" class="view-btn" onclick="setViewMode('single', 'ila')">üë§ Per Siswa</button></div>
                <div class="nav-controls" id="navControlsILA"><button class="nav-btn" onclick="changeStudent(-1, 'ila')">‚óÄ</button><select id="studentSelectorILA" onchange="jumpToStudent('ila')"></select><button class="nav-btn" onclick="changeStudent(1, 'ila')">‚ñ∂</button></div>
            </div>
            <div class="main-content" id="outputILA"><div style="color:white; margin-top:50px;"><h3>Silakan Upload Leger ILA</h3></div></div>
        </div>
    </div>

    <div id="hidden-processing"></div>

    <script>
        // ==========================================
        //  STRUKTUR ILA YANG BENAR
        // ==========================================
        const ilaStructure = [ 
            { 
                dim: "1. Self Discipline", 
                vals: [ 
                    { 
                        name: "Independence", 
                        cats: [ 
                            { code: "1.1.1", title: "Independence in Self-Care", inds: [{c:"1.1.1.1",t:"Students demonstrate initiative in waking up early, grooming themselves, and regularly cleaning their nails and hair independently."},{c:"1.1.1.2",t:"Students can independently perform a major bath/ablution (for boys) and clean/dispose of sanitary pads properly (for girls)."},{c:"1.1.1.3",t:"Students show initiative in maintaining their own health by exercising routinely and managing their dietary intake."}] }, 
                            { code: "1.1.2", title: "Independence in Learning", inds: [{c:"1.1.2.1",t:"Independently preparing and bringing appropriate school supplies."},{c:"1.1.2.2",t:"Entering class on time and completing all assignments given by the teacher."},{c:"1.1.2.3",t:"Studying at home to prepare specifically for upcoming material and completing homework for the following day."}] }, 
                            { code: "1.1.3", title: "Social and Emotional Independence", inds: [{c:"1.1.3.1",t:"Students can form friendships with people from diverse backgrounds without discriminating."},{c:"1.1.3.2",t:"Students are able to manage their emotions during social interactions and understand the circumstances of others."},{c:"1.1.3.3",t:"Students can resolve conflicts with peers and express their wishes/needs appropriately to their friends."},{c:"1.1.3.4",t:"Students can collaborate with anyone and do not avoid or exclude specific peers."}] }, 
                            { code: "1.1.4", title: "Independence in Decision Making and Problem Solving", inds: [{c:"1.1.4.1",t:"Capable of making decisions aligned with their own interests and potential, particularly when selecting extracurricular activities and organizations."},{c:"1.1.4.2",t:"Have the courage to say \"no\" when asked to do something uncomfortable or wrong."},{c:"1.1.4.3",t:"Determine activity priorities (e.g., finishing assignments before playing games)."}] },
                            { code: "1.1.5", title: "Independence in Worship (Spiritual Independence)", inds: [{c:"1.1.5.1",t:"Students consciously perform the 5 obligatory prayers and Sunnah prayers in accordance with Islamic law (Fiqh)."},{c:"1.1.5.2",t:"Students demonstrate proper etiquette (adab) in places of worship and are able to maintain their cleanliness."},{c:"1.1.5.3",t:"Students are disciplined in making obligatory and Sunnah worship a priority over other activities."}] },
                            { code: "1.1.6", title: "Financial Independence", inds: [{c:"1.1.6.1",t:"Students are able to practice self-control and manage their allowance/pocket money effectively."},{c:"1.1.6.2",t:"Students understand the concept of Sadaqah/Infaq (charity) as part of financial obligations in Islam."}] }
                        ] 
                    }, 
                    { 
                        name: "Disclipine", 
                        cats: [ 
                            { code: "1.2.1", title: "Students are able to follow class and school rules", inds: [{c:"1.2.1.1",t:"Students arrive at school on time wearing a complete and neat uniform."},{c:"1.2.1.2",t:"Students arrive on time for worship sessions and other school activities."},{c:"1.2.1.3",t:"Students are supportive and participate actively in tasks and directions given by teachers."}] }, 
                            { code: "1.2.2", title: "Students are able to follow rules at home", inds: [{c:"1.2.2.1",t:"Students supportively perform daily tasks such as studying at home, reciting the Quran (Mengaji), preparing for school, etc."},{c:"1.2.2.2",t:"Students are disciplined regarding worship times, screen time limits, dress codes, and rules for going out as established by parents at home."},{c:"1.2.2.3",t:"Students behave respectfully toward parents and siblings, and assist their parents at home."}] } 
                        ] 
                    }, 
                    { 
                        name: "Honest", 
                        cats: [ 
                            { code: "1.3.1", title: "Students are able to convey the truth", inds: [{c:"1.3.1.1",t:"Students speak honestly and have the courage to speak the truth when a friend behaves badly."},{c:"1.3.1.2",t:"Students have the courage to reprimand other students who commit mistakes."}] },
                            { code: "1.3.2", title: "Students are able to admit mistakes", inds: [{c:"1.3.2.1",t:"Students have the courage to admit their mistakes and apologize."},{c:"1.3.2.2",t:"Students do not blame others for their own mistakes."}] },
                            { code: "1.3.3", title: "Students do not steal or take others' belongings", inds: [{c:"1.3.3.1",t:"Students ask for permission when borrowing items."},{c:"1.3.3.2",t:"Do not take others' rights, whether in the form of goods or creative work."},{c:"1.3.3.3",t:"Returning items that do not belong to them to the owner (when finding something)."}] },
                            { code: "1.3.4", title: "Students are honest in completing assignments and exams", inds: [{c:"1.3.4.1",t:"Students complete assignments and exams using their own abilities and do not cheat, such as asking for or giving answers to others."},{c:"1.3.4.2",t:"Using time according to the purpose; not pretending to study or work."}] }
                        ] 
                    }, 
                    { 
                        name: "Patient", 
                        cats: [ 
                            { code: "1.4.1", title: "Patience in academic matters", inds: [{c:"1.4.1.1",t:"Patient in carrying out tasks, increasing memorization, and receiving lessons from teachers."}] }, 
                            { code: "1.4.2", title: "Patience in non-academic matters", inds: [{c:"1.4.2.1",t:"Patient in friendship; patient with circumstances that do not meet expectations."},{c:"1.4.2.2",t:"Patient in waiting in line (queuing)."},{c:"1.4.2.3",t:"Patient in accepting input or advice from others."}] } 
                        ] 
                    } 
                ] 
            }, 
            { 
                dim: "2. Respect", 
                vals: [ 
                    { 
                        name: "Politeness", 
                        cats: [ 
                            { code: "2.1.1", title: "Students are able to use polite words", inds: [{c:"2.1.1.1",t:"Students speak politely to anyone (applying the 3 S: Senyum (smile), Sapa (greet), Salam (peace), and the 4 magic words: sorry, excuse me, please, thank you)."}] }, 
                            { code: "2.1.2", title: "Students are able to respect others", inds: [{c:"2.1.2.1",t:"Students pay attention and listen carefully when others are speaking."},{c:"2.1.2.2",t:"Students pay attention to the teacher's explanation and do not talk amongst themselves."}] },
                            { code: "2.1.3", title: "Students are able to use polite body language", inds: [{c:"2.1.3.1",t:"Students shake hands with people they meet or bow slightly politely when passing in front of others."}] }
                        ] 
                    }, 
                    { 
                        name: "Social Care", 
                        cats: [ 
                            { code: "2.2.1", title: "Willingness to Help Others / Social Solidarity", inds: [{c:"2.2.1.1",t:"Students are always willing to lend a hand/help friends in need."}] }, 
                            { code: "2.2.2", title: "Active Participation in Social Activities / Communal Concern", inds: [{c:"2.2.2.1",t:"Students participate in social activities in the community around their home or school."}] }, 
                            { code: "2.2.3", title: "Responsibility towards Environment and Public Facilities", inds: [{c:"2.2.3.1",t:"Students maintain the cleanliness of the shared environment and take care of shared property/assets."}] } 
                        ] 
                    }, 
                    { 
                        name: "Tolerance", 
                        cats: [ 
                            { code: "2.3.1", title: "Students are able to appreciate differences", inds: [{c:"2.3.1.1",t:"Students are willing to be friends with everyone, recognizing and understanding physical differences, hobbies, and cultures of other friends."},{c:"2.3.1.2",t:"Avoid and strictly do not commit bullying by not mocking, oppressing, or making friends feel intimidated."}] }, 
                            { code: "2.3.2", title: "Students value other people's feelings", inds: [{c:"2.3.2.1",t:"Students give attention to their friends, listen to advice, and behave well towards others."}] } 
                        ] 
                    }, 
                    { 
                        name: "Emphaty", 
                        cats: [ 
                            { code: "2.4.1", title: "Students show caring behavior", inds: [{c:"2.4.1.1",t:"Students remain silent and listen to other friends who are presenting or speaking."},{c:"2.4.1.2",t:"Students offer help when someone is in trouble."},{c:"2.4.1.3",t:"Lending stationery to friends who did not bring theirs."},{c:"2.4.1.4",t:"Sharing food or drink with friends in need."}] }, 
                            { code: "2.4.2", title: "Students show concern and share in others' happiness or sadness", inds: [{c:"2.4.2.1",t:"Students visit sick friends and bring gifts."},{c:"2.4.2.2",t:"Expressing condolences and paying respects (Takziah) when a friend's family member or neighbor passes away."}] }, 
                            { code: "2.4.3", title: "Listening and providing support", inds: [{c:"2.4.3.1",t:"Encourage friends who are sad because of bad grades or failure, for example by inviting them to study together."},{c:"2.4.3.2",t:"Comforting friends who are grieving or sad."}] } 
                        ] 
                    } 
                ] 
            } 
        ];

        // PERUBAHAN: DESKRIPSI GRADING SCALE UNTUK HALAMAN 1 (TETAP SAMA)
        const gradingDesc = {
            "5": "Students consistently demonstrate the expected character behavior, often exceeding expectations and inspiring others to behave similarly.",
            "4": "Students consistently or often demonstrate the expected character behavior in various relevant situations.",
            "3": "Students are starting to demonstrate the expected character behavior, but not yet consistent and still require guidance or support in some situations.",
            "2": "Students show few signs of the expected character behavior and require significant guidance as well as intensive intervention.",
            "1": "Students have not yet demonstrated the expected character behavior or show significantly contradictory behavior."
        };

        // PERUBAHAN: FUNGSI BARU UNTUK GET DESKRIPSI DI SUMMARY BERDASARKAN RANGE
        function getDescriptionFromAverageForSummary(avg) {
            const numericAvg = parseFloat(avg);
            
            if (numericAvg >= 4.5 && numericAvg <= 5) {
                return "Student consistently demonstrate the expected character behavior, often exceeding expectations and inspiring others to behave similarity";
            } else if (numericAvg >= 4.00 && numericAvg <= 4.49) {
                return "Student consistently or often demonstrate the expected character behavior in various relevant situations";
            } else if (numericAvg >= 3.5 && numericAvg <= 3.99) {
                return "Student are starting to demonstrate the expected character behavior";
            } else if (numericAvg >= 3 && numericAvg <= 3.49) {
                return "Student are starting to demonstrate the expected character behavior, but not yet consistent and still require guidance or support in some situation";
            } else if (numericAvg >= 2 && numericAvg <= 2.99) {
                return "Students show few signs of the expected character behavior and require significant guidance as well as intensive intervention";
            } else if (numericAvg >= 0 && numericAvg <= 1.99) {
                return "Students have not yet demonstrated the expected character behavior or show significantly contradictory behavior";
            } else {
                return "No description available";
            }
        }

        // --- GLOBAL STATE ---
        let wbDinas = null, wbILA = null;
        let globalDataDinas = [], globalDataILA = [];
        let viewMode = { dinas: 'all', ila: 'all' };
        let studentIndex = { dinas: 0, ila: 0 };
        const LS_KEY = 'rapor_abbs_v83';
        
        // SIGNATURE DATA STRUCTURE YANG DIPERBAIKI
        let sigData = { 
            dinas: { img: null, x: 50, y: 20, scale: 1 },
            ila: { img: null, x: 50, y: 20, scale: 1 },
            kepsek: { img: null, x: 50, y: 10, scale: 1 }
        };

        // VARIABEL UNTUK FLOATING BUTTON
        let currentAppType = null;

        // ==========================================
        //  UTILITY FUNCTIONS
        // ==========================================

        const safeVal = (v) => (v === undefined || v === null || v === '') ? '-' : v;
        function sanitizeFilename(name) { return name.replace(/[^a-z0-9 ]/gi, '').trim().replace(/\s+/g, '_'); }
        function toTitleCase(str) { 
            if (!str) return "";
            const specialCases = ['NIP', 'NIS', 'NISN', 'SD'];
            const words = str.split(' ');
            return words.map(w => {
                const upperW = w.toUpperCase();
                if (specialCases.includes(upperW)) return upperW;
                return w.charAt(0).toUpperCase() + w.slice(1).toLowerCase();
            }).join(' '); 
        }

        function getScore(row, prefix, code) { 
            const keys = Object.keys(row); 
            const target = keys.find(k => {
                const normalizedKey = k.toString().toLowerCase().replace(/\s+/g, ' ');
                const searchPattern = `${code} ${prefix}`.toLowerCase();
                return normalizedKey.includes(searchPattern) || 
                       normalizedKey.includes(`${prefix} ${code}`.toLowerCase());
            }); 
            return target ? row[target] : '';
        }

        function calculateValueAverage(siswa, valueObj) {
            let total = 0, count = 0;
            
            valueObj.cats.forEach(cat => {
                cat.inds.forEach(ind => {
                    ['Siswa', 'Guru', 'Ortu'].forEach(p => {
                        const score = getScore(siswa, p, ind.c);
                        const v = parseFloat(score);
                        
                        if (!isNaN(v) && v >= 0 && v <= 5) { 
                            total += v; 
                            count++; 
                        }
                    });
                });
            });
            
            if (count === 0) return 0;
            
            const avg = total / count;
            return parseFloat(avg.toFixed(2));
        }

        // PERUBAHAN: FUNGSI LAMA TETAP ADA UNTUK HALAMAN 1
        function getDescriptionFromAverage(avg) {
            const numericAvg = parseFloat(avg);
            
            if (numericAvg >= 4.5) return gradingDesc["5"];
            if (numericAvg >= 3.5) return gradingDesc["4"];
            if (numericAvg >= 2.5) return gradingDesc["3"];
            if (numericAvg >= 1.5) return gradingDesc["2"];
            return gradingDesc["1"];
        }

        function getPredikatShort(avg) {
            if (avg >= 4.5) return "HD";
            if (avg >= 3.5) return "DSE";
            if (avg >= 2.5) return "SD";
            if (avg >= 1.5) return "DI";
            return "NYD";
        }

        // ==========================================
        //  FLOATING DOWNLOAD BUTTON FUNCTIONS
        // ==========================================

        function showFloatingDownloadButton(type) {
            removeFloatingDownloadButton();
            
            const button = document.createElement('button');
            button.className = `floating-download-btn ${type === 'ila' ? 'ila-mode pulse' : 'pulse'}`;
            button.id = 'floatingDownloadBtn';
            button.innerHTML = `
                <span class="btn-text">Download Siswa Ini</span>
                <span>üì•</span>
            `;
            
            button.addEventListener('click', function() {
                downloadCurrentStudent(type);
            });
            
            document.body.appendChild(button);
            currentAppType = type;
        }

        function removeFloatingDownloadButton() {
            const existingBtn = document.getElementById('floatingDownloadBtn');
            if (existingBtn) {
                existingBtn.remove();
            }
            currentAppType = null;
        }

        async function downloadCurrentStudent(type) {
            const res = getDataAndConf(type);
            if (!res) {
                Swal.fire('Oops...', 'Data tidak ditemukan. Silakan upload file leger terlebih dahulu!', 'warning');
                return;
            }
            
            const idx = studentIndex[type];
            const siswa = res.data[idx];
            const name = siswa.Nama || siswa['Nama Siswa'] || `Siswa ${idx + 1}`;
            
            if (!siswa) {
                Swal.fire('Oops...', 'Data siswa tidak ditemukan!', 'error');
                return;
            }
            
            const btn = document.getElementById('floatingDownloadBtn');
            if (btn) {
                btn.classList.add('loading');
                btn.innerHTML = `
                    <span class="btn-text">Menyiapkan file...</span>
                    <span>‚è≥</span>
                `;
            }
            
            try {
                const pdfDoc = await PDFLib.PDFDocument.create();
                const A4_W = 595.28;
                const A4_H = 841.89;
                const hiddenDiv = document.getElementById('hidden-processing');
                
                hiddenDiv.innerHTML = '';
                const pages = (type === 'dinas') 
                    ? generateDinasPages(siswa, res.conf, hiddenDiv) 
                    : generateILAPages(siswa, res.conf);

                for (const pageEl of pages) {
                    const textContent = pageEl.innerText.trim();
                    const hasImages = pageEl.querySelectorAll('img').length > 0;
                    const hasTables = pageEl.querySelectorAll('table').length > 0;
                    
                    if (textContent.length < 5 && !hasImages && !hasTables) continue;

                    hiddenDiv.innerHTML = '';
                    hiddenDiv.appendChild(pageEl);

                    const canvas = await html2canvas(pageEl, {
                        scale: 2,
                        useCORS: true,
                        logging: false,
                        windowWidth: 210 * 3.7795275591,
                        windowHeight: 297 * 3.7795275591
                    });
                    
                    const imgData = canvas.toDataURL('image/jpeg', 0.9);
                    const img = await pdfDoc.embedJpg(imgData);
                    const page = pdfDoc.addPage([A4_W, A4_H]);
                    page.drawImage(img, { x: 0, y: 0, width: A4_W, height: A4_H });
                }

                const pdfBytes = await pdfDoc.save();
                const blob = new Blob([pdfBytes], { type: "application/pdf" });
                
                const fileName = sanitizeFilename(`${type.toUpperCase()}_${res.conf.kelas}_${name}.pdf`);
                saveAs(blob, fileName);
                
                Swal.fire({
                    icon: 'success',
                    title: 'Berhasil!',
                    text: `File ${name} telah diunduh.`,
                    timer: 2000,
                    showConfirmButton: false
                });
                
            } catch (err) {
                console.error(err);
                Swal.fire({
                    icon: 'error',
                    title: 'Gagal',
                    text: 'Terjadi kesalahan saat mengunduh file: ' + err.message
                });
            } finally {
                const hiddenDiv = document.getElementById('hidden-processing');
                hiddenDiv.innerHTML = '';
                if (btn) {
                    btn.classList.remove('loading');
                    btn.innerHTML = `
                        <span class="btn-text">Download Siswa Ini</span>
                        <span>üì•</span>
                    `;
                }
            }
        }

        // ==========================================
        //  FUNGSI UTAMA
        // ==========================================

        function getDataAndConf(type) {
            if(type === 'dinas') {
                const sheet = document.getElementById('sheetDinas').value;
                if(!sheet || !wbDinas) return null;
                const ws = wbDinas.Sheets[sheet];
                const data = XLSX.utils.sheet_to_json(ws, {defval: ''});
                globalDataDinas = data;
                
                return {
                    data: data,
                    conf: {
                        sekolah: document.getElementById('dinasSekolah').value,
                        alamat: document.getElementById('dinasAlamat').value,
                        kepsek: document.getElementById('dinasKepsek').value,
                        kelas: document.getElementById('dinasKelas').value,
                        fase: document.getElementById('dinasFase').value,
                        sem: document.getElementById('dinasSem').value,
                        thn: document.getElementById('dinasThn').value,
                        tgl: document.getElementById('dinasTgl').value,
                        wali: document.getElementById('dinasWali').value,
                        nip: document.getElementById('dinasNIP').value,
                        nipKepsek: document.getElementById('dinasNIPKepsek').value
                    }
                };
            } else {
                const sheet = document.getElementById('sheetILA').value;
                if(!sheet || !wbILA) return null;
                const ws = wbILA.Sheets[sheet];
                const data = XLSX.utils.sheet_to_json(ws, {defval: ''});
                globalDataILA = data;
                
                return {
                    data: data,
                    conf: {
                        sekolah: document.getElementById('ilaSekolah').value,
                        tgl: document.getElementById('ilaTgl').value,
                        wali: document.getElementById('ilaWali').value,
                        kelas: document.getElementById('ilaKelas').value
                    }
                };
            }
        }

        // ==========================================
        //  NAVIGATION & UI FUNCTIONS
        // ==========================================
        function switchApp(app) {
            document.getElementById('landing-page').style.display = 'none';
            document.getElementById('app-dinas').style.display = app === 'dinas' ? 'flex' : 'none';
            document.getElementById('app-ila').style.display = app === 'ila' ? 'flex' : 'none';
            currentAppType = app;
        }
        
        function goHome() {
            document.getElementById('landing-page').style.display = 'flex';
            document.getElementById('app-dinas').style.display = 'none';
            document.getElementById('app-ila').style.display = 'none';
            removeFloatingDownloadButton();
            currentAppType = null;
        }
        
        function toggleSidebar(app) { 
            document.getElementById('sidebar-' + app).classList.toggle('closed'); 
        }
        
        function resetApp() {
            Swal.fire({ 
                title: 'Reset Data?', 
                text: 'Semua data dan pengaturan akan dihapus.', 
                icon: 'warning', 
                showCancelButton: true 
            }).then((result) => {
                if (result.isConfirmed) { 
                    localStorage.removeItem(LS_KEY); 
                    location.reload(); 
                }
            });
        }

        // ==========================================
        //  SIGNATURE FUNCTIONS
        // ==========================================

        function handleSigUpload(e, type) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => { 
                sigData[type].img = evt.target.result; 
                sigData[type].scale = 1;
                
                if (type === 'kepsek') {
                    sigData[type].x = 50;
                    sigData[type].y = 10;
                }
                
                saveData('dinas');
                updateSigPreview(type);
                updateSignatureOnly(type);
            };
            reader.readAsDataURL(file);
        }

        function updateSigPreview(type) {
            const previewContainer = document.getElementById(`sigPreview${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const zoomSlider = document.getElementById(`zoomSlider${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const zoomValue = document.getElementById(`zoomValue${type.charAt(0).toUpperCase() + type.slice(1)}`);
            
            if (!previewContainer) return;
            
            previewContainer.innerHTML = '';
            
            if (sigData[type] && sigData[type].img) {
                const img = document.createElement('img');
                img.src = sigData[type].img;
                img.className = 'sig-preview';
                img.style.transform = `scale(${sigData[type].scale})`;
                img.style.cursor = 'move';
                img.dataset.type = type;
                
                const containerWidth = previewContainer.clientWidth;
                const containerHeight = previewContainer.clientHeight;
                const imgWidth = 150 * sigData[type].scale;
                const imgHeight = 80 * sigData[type].scale;
                
                const centerX = (containerWidth - imgWidth) / 2;
                const centerY = (containerHeight - imgHeight) / 2;
                
                if (!sigData[type].x || sigData[type].x === 0) {
                    sigData[type].x = centerX;
                }
                if (!sigData[type].y || sigData[type].y === 0) {
                    if (type === 'kepsek') {
                        sigData[type].y = 10;
                    } else {
                        sigData[type].y = centerY;
                    }
                }
                
                img.style.left = `${sigData[type].x}px`;
                img.style.top = `${sigData[type].y}px`;
                img.style.position = 'absolute';
                
                makeElementDraggable(img, type, true);
                previewContainer.appendChild(img);
                
                if (zoomSlider) zoomSlider.value = sigData[type].scale * 100;
                if (zoomValue) zoomValue.textContent = Math.round(sigData[type].scale * 100) + '%';
            } else {
                previewContainer.innerHTML = '<div style="color: #94a3b8; font-size: 12px;">Upload tanda tangan</div>';
            }
        }

        function updateSignatureOnly(type) {
            const allSignatures = document.querySelectorAll(`.draggable-sig[data-type="${type}"]`);
            const scale = sigData[type].scale || 1;
            
            allSignatures.forEach(sig => {
                sig.style.transform = `scale(${scale})`;
                if (sigData[type].x !== undefined && sigData[type].y !== undefined) {
                    sig.style.left = `${sigData[type].x}px`;
                    sig.style.top = `${sigData[type].y}px`;
                }
                
                if (sigData[type].img && sig.src !== sigData[type].img) {
                    sig.src = sigData[type].img;
                }
            });
        }

        function adjustSigZoom(type, delta) {
            const currentScale = sigData[type].scale || 1;
            let newScale = currentScale + delta;
            newScale = Math.max(0.1, Math.min(2.0, newScale));
            sigData[type].scale = newScale;
            saveData('dinas');
            updateSigPreview(type);
            updateSignatureOnly(type);
        }

        function updateSigZoom(type, value, immediate = false) {
            const scale = parseInt(value) / 100;
            sigData[type].scale = scale;
            saveData('dinas');
            updateSigPreview(type);
            if (immediate) {
                updateSignatureOnly(type);
            }
        }

        function resetSigSize(type) {
            sigData[type].scale = 1;
            saveData('dinas');
            updateSigPreview(type);
            updateSignatureOnly(type);
        }

        function clearSig(type) {
            sigData[type].img = null;
            sigData[type].scale = 1;
            sigData[type].x = 50;
            sigData[type].y = type === 'kepsek' ? 10 : 20;
            saveData('dinas');
            updateSigPreview(type);
            
            const allSignatures = document.querySelectorAll(`.draggable-sig[data-type="${type}"]`);
            allSignatures.forEach(sig => sig.remove());
        }

        function resetSigPos(type) {
            const previewContainer = document.getElementById(`sigPreview${type.charAt(0).toUpperCase() + type.slice(1)}`);
            if (previewContainer) {
                const containerWidth = previewContainer.clientWidth;
                const containerHeight = previewContainer.clientHeight;
                const imgWidth = 150 * (sigData[type].scale || 1);
                const imgHeight = 80 * (sigData[type].scale || 1);
                
                sigData[type].x = (containerWidth - imgWidth) / 2;
                
                if (type === 'kepsek') {
                    sigData[type].y = 10;
                } else {
                    sigData[type].y = (containerHeight - imgHeight) / 2;
                }
            } else {
                sigData[type].x = 50;
                sigData[type].y = type === 'kepsek' ? 10 : 20;
            }
            
            saveData('dinas');
            updateSigPreview(type);
            updateSignatureOnly(type);
        }

        // ==========================================
        //  DRAGGABLE FUNCTIONALITY
        // ==========================================
        let activeDrag = null; 
        let startX = 0, startY = 0, initL = 0, initT = 0;
        
        function getEventCoordinates(e) {
            if (e.type.includes('touch')) {
                const touch = e.touches[0] || e.changedTouches[0];
                return {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                };
            } else {
                return {
                    clientX: e.clientX,
                    clientY: e.clientY
                };
            }
        }

        function makeElementDraggable(element, type, isInPreview = true) {
            element.addEventListener('mousedown', function(e) {
                startDrag(e, element, type, isInPreview);
            });
            
            element.addEventListener('touchstart', function(e) {
                startDrag(e, element, type, isInPreview);
            }, { passive: false });
        }

        function startDrag(e, element, type, isInPreview) {
            if (e.preventDefault) e.preventDefault();
            if (e.stopPropagation) e.stopPropagation();
            
            const coords = getEventCoordinates(e);
            activeDrag = {element, type, isInPreview};
            startX = coords.clientX;
            startY = coords.clientY;
            
            if (isInPreview) {
                const rect = element.getBoundingClientRect();
                const container = element.parentElement.getBoundingClientRect();
                initL = rect.left - container.left;
                initT = rect.top - container.top;
            } else {
                initL = parseInt(element.style.left || 0);
                initT = parseInt(element.style.top || 0);
            }
            
            element.style.cursor = 'grabbing';
            element.style.zIndex = '1000';
            element.classList.add('dragging');
        }

        function updateDragPosition(e) {
            if (!activeDrag) return;
            
            if (e.preventDefault) e.preventDefault();
            const coords = getEventCoordinates(e);
            
            const deltaX = coords.clientX - startX;
            const deltaY = coords.clientY - startY;
            
            activeDrag.element.style.left = (initL + deltaX) + "px";
            activeDrag.element.style.top = (initT + deltaY) + "px";
        }

        function endDrag() {
            if (!activeDrag) return;
            
            const t = activeDrag.type;
            
            if (activeDrag.isInPreview) {
                const rect = activeDrag.element.getBoundingClientRect();
                const container = activeDrag.element.parentElement.getBoundingClientRect();
                sigData[t].x = rect.left - container.left;
                sigData[t].y = rect.top - container.top;
            } else {
                sigData[t].x = parseInt(activeDrag.element.style.left || 0);
                sigData[t].y = parseInt(activeDrag.element.style.top || 0);
                
                document.querySelectorAll(`.draggable-sig[data-type="${t}"]`).forEach(img => {
                    img.style.left = activeDrag.element.style.left; 
                    img.style.top = activeDrag.element.style.top;
                });
            }
            
            saveData('dinas');
            activeDrag.element.style.cursor = 'move';
            activeDrag.element.style.zIndex = '10';
            activeDrag.element.classList.remove('dragging');
            activeDrag = null;
        }

        document.addEventListener('mousemove', function(e) {
            if (activeDrag) {
                updateDragPosition(e);
            }
        });

        document.addEventListener('touchmove', function(e) {
            if (activeDrag) {
                updateDragPosition(e);
            }
        }, { passive: false });

        document.addEventListener('mouseup', function() {
            endDrag();
        });

        document.addEventListener('touchend', function() {
            endDrag();
        });

        document.addEventListener('touchcancel', function() {
            endDrag();
        });

        function getSigHTML(type) {
            if (sigData[type] && sigData[type].img) {
                const scale = sigData[type].scale || 1;
                const transform = `scale(${scale})`;
                const x = sigData[type].x !== undefined ? sigData[type].x : 50;
                const y = sigData[type].y !== undefined ? sigData[type].y : (type === 'kepsek' ? 10 : 20);
                
                return `<img src="${sigData[type].img}" 
                          class="draggable-sig" 
                          data-type="${type}" 
                          style="left:${x}px; top:${y}px; transform:${transform}; max-width:150px; max-height:80px; position:absolute;"
                          onload="makeElementDraggable(this, '${type}', false)">`;
            }
            return '';
        }

        // ==========================================
        //  PERSISTENCE & DATA MANAGEMENT
        // ==========================================

        function saveData(type) {
            let cur = JSON.parse(localStorage.getItem(LS_KEY)) || {};
            if (!cur.dinas) cur.dinas = {}; 
            if (!cur.ila) cur.ila = {};
            
            if (type === 'dinas') {
                ['sekolah', 'alamat', 'kepsek', 'kelas', 'fase', 'sem', 'thn', 'tgl', 'wali', 'nip'].forEach(k => {
                    const el = document.getElementById('dinas' + toTitleCase(k));
                    if (el) cur.dinas[k] = el.value;
                });
                
                const nipKepsekEl = document.getElementById('dinasNIPKepsek');
                if (nipKepsekEl) cur.dinas.nipKepsek = nipKepsekEl.value;
            } else {
                ['sekolah', 'tgl', 'wali', 'kelas'].forEach(k => {
                    const el = document.getElementById('ila' + toTitleCase(k));
                    if (el) cur.ila[k] = el.value;
                });
            }
            
            cur.sigData = sigData;
            localStorage.setItem(LS_KEY, JSON.stringify(cur));
        }

        function initSigPreviews() {
            ['dinas', 'ila', 'kepsek'].forEach(type => {
                updateSigPreview(type);
            });
        }

        window.onload = function() {
            const saved = JSON.parse(localStorage.getItem(LS_KEY));
            if(saved) {
                if (saved.sigData) {
                    sigData = saved.sigData;
                    if (!sigData.dinas.scale) sigData.dinas.scale = 1;
                    if (!sigData.ila.scale) sigData.ila.scale = 1;
                    if (!sigData.kepsek) sigData.kepsek = { img: null, x: 50, y: 10, scale: 1 };
                    if (!sigData.kepsek.scale) sigData.kepsek.scale = 1;
                    
                    if (!sigData.dinas.x) sigData.dinas.x = 50;
                    if (!sigData.dinas.y) sigData.dinas.y = 20;
                    if (!sigData.ila.x) sigData.ila.x = 50;
                    if (!sigData.ila.y) sigData.ila.y = 20;
                    if (!sigData.kepsek.x) sigData.kepsek.x = 50;
                    if (!sigData.kepsek.y) sigData.kepsek.y = 10;
                }
                
                if(saved.dinas) {
                    Object.keys(saved.dinas).forEach(k => { 
                        const el = document.getElementById('dinas' + toTitleCase(k)); 
                        if(el) el.value = saved.dinas[k]; 
                    });
                    
                    const nipKepsekEl = document.getElementById('dinasNIPKepsek');
                    if (nipKepsekEl && saved.dinas.nipKepsek) {
                        nipKepsekEl.value = saved.dinas.nipKepsek;
                    }
                }
                
                if(saved.ila) Object.keys(saved.ila).forEach(k => { 
                    const el = document.getElementById('ila' + toTitleCase(k)); 
                    if(el) el.value = saved.ila[k]; 
                });
                
                setTimeout(initSigPreviews, 100);
            }
            
            document.getElementById('fileDinas').addEventListener('change', (e) => handleUpload(e, 'dinas'));
            document.getElementById('fileILA').addEventListener('change', (e) => handleUpload(e, 'ila'));
        };

        // ==========================================
        //  EXCEL UPLOAD HANDLERS
        // ==========================================

        function handleUpload(e, type) {
            const file = e.target.files[0];
            if (!file) return;
            Swal.fire({ title: 'Membaca File...', didOpen: () => { Swal.showLoading(); } });
            const reader = new FileReader();
            reader.onload = function(evt) {
                try {
                    const data = new Uint8Array(evt.target.result);
                    const wb = XLSX.read(data, {type:'array'});
                    if(type === 'dinas') wbDinas = wb; else wbILA = wb;
                    const sel = document.getElementById(type === 'dinas' ? 'sheetDinas' : 'sheetILA');
                    sel.innerHTML = "";
                    wb.SheetNames.forEach(n => { const opt = document.createElement('option'); opt.value = n; opt.textContent = n; sel.appendChild(opt); });
                    sel.disabled = false;
                    autoFillClass(type);
                    Swal.fire({ icon: 'success', title: 'Berhasil!', timer: 1500, showConfirmButton: false });
                } catch (err) { Swal.fire('Error', 'Gagal membaca file.', 'error'); }
            };
            reader.readAsArrayBuffer(file);
        }

        function autoFillClass(type) {
            const sel = document.getElementById(type === 'dinas' ? 'sheetDinas' : 'sheetILA').value;
            const match = sel.match(/([789][A-Z])/i);
            const val = match ? match[0].toUpperCase() : sel;
            document.getElementById(type === 'dinas' ? 'dinasKelas' : 'ilaKelas').value = val;
            saveData(type);
        }

        // ==========================================
        //  PREVIEW & RENDER FUNCTIONS
        // ==========================================

        function processPreview(type) {
            const res = getDataAndConf(type);
            if(!res) { Swal.fire('Oops...', 'Silakan upload file leger terlebih dahulu!', 'warning'); return; }
            
            const selId = type === 'dinas' ? 'studentSelectorDinas' : 'studentSelectorILA';
            const selector = document.getElementById(selId);
            selector.innerHTML = '';
            res.data.forEach((s, i) => {
                const opt = document.createElement('option');
                opt.value = i;
                opt.text = (i+1) + ". " + (s.Nama || s['Nama Siswa']);
                selector.appendChild(opt);
            });
            studentIndex[type] = 0; 
            renderUI(type);
        }

        function renderUI(type) {
            const res = getDataAndConf(type);
            if(!res) return;
            const out = document.getElementById(type === 'dinas' ? 'outputDinas' : 'outputILA');
            out.innerHTML = "";
            const hiddenProc = document.getElementById('hidden-processing');
            hiddenProc.innerHTML = '';

            const mode = viewMode[type];
            const idx = studentIndex[type];

            if (mode === 'all') {
                res.data.forEach(siswa => {
                    const pages = (type === 'dinas') ? generateDinasPages(siswa, res.conf, hiddenProc) : generateILAPages(siswa, res.conf);
                    pages.forEach(p => out.appendChild(p));
                });
                
                removeFloatingDownloadButton();
            } else {
                const siswa = res.data[idx];
                document.getElementById(type === 'dinas' ? 'studentSelectorDinas' : 'studentSelectorILA').value = idx;
                const pages = (type === 'dinas') ? generateDinasPages(siswa, res.conf, hiddenProc) : generateILAPages(siswa, res.conf);
                pages.forEach(p => out.appendChild(p));
                
                showFloatingDownloadButton(type);
            }
            hiddenProc.innerHTML = '';
        }

        function setViewMode(mode, type) {
            viewMode[type] = mode;
            const btnAll = document.getElementById(type === 'dinas' ? 'btnViewAllDinas' : 'btnViewAllILA');
            const btnSingle = document.getElementById(type === 'dinas' ? 'btnViewSingleDinas' : 'btnViewSingleILA');
            const navControl = document.getElementById(type === 'dinas' ? 'navControlsDinas' : 'navControlsILA');
            
            btnAll.className = mode === 'all' ? 'view-btn active' : 'view-btn';
            btnSingle.className = mode === 'single' ? 'view-btn active' : 'view-btn';
            navControl.style.display = mode === 'single' ? 'flex' : 'none';
            
            const res = getDataAndConf(type);
            if(res) {
                renderUI(type);
                
                if (mode === 'single') {
                    showFloatingDownloadButton(type);
                } else {
                    removeFloatingDownloadButton();
                }
            }
        }

        function changeStudent(dir, type) {
            const data = (type === 'dinas') ? globalDataDinas : globalDataILA;
            let newIndex = studentIndex[type] + dir;
            if(newIndex >= 0 && newIndex < data.length) {
                studentIndex[type] = newIndex;
                const res = getDataAndConf(type);
                if(res) renderUI(type);
            }
        }
        
        function jumpToStudent(type) {
            const selId = type === 'dinas' ? 'studentSelectorDinas' : 'studentSelectorILA';
            studentIndex[type] = parseInt(document.getElementById(selId).value);
            const res = getDataAndConf(type);
            if(res) renderUI(type);
        }

        // ==========================================
        //  GENERATOR DINAS PAGES
        // ==========================================
        function generateDinasPages(siswa, conf, measureContainer) {
            let pageNum = 1;
            const pages = [];
            const row = (n,m,v,d) => `<tr><td class="cell-center">${n}</td><td class="cell-left">${m}</td><td class="cell-center bold">${safeVal(v)}</td><td class="cell-justify" style="font-size:10pt;">${safeVal(d)}</td></tr>`;
            const sakit=siswa['SAKIT ']||siswa['Sakit']||'-', izin=siswa['IJIN']||siswa['Ijin']||'-', alpha=siswa['TANPA KETERANGAN']||siswa['Tanpa Keterangan']||'-';
            
            const headerHTML = `<div class="header-container"><table class="dinas-header"><colgroup><col style="width:130px;"><col style="width:10px;"><col><col style="width:130px;"><col style="width:10px;"><col style="width:100px;"></colgroup><tr><td>Nama</td><td>:</td><td>${toTitleCase(siswa.Nama)}</td><td>Kelas</td><td>:</td><td>${conf.kelas}</td></tr><tr><td>NIS / NISN</td><td>:</td><td>${siswa.NIS||'-'} / ${siswa.NISN||'-'}</td><td>Fase</td><td>:</td><td>${conf.fase}</td></tr><tr><td>Nama Sekolah</td><td>:</td><td>${conf.sekolah}</td><td>Semester</td><td>:</td><td>${conf.sem}</td></tr><tr><td>Alamat </td><td>:</td><td style="font-size:11pt;">${conf.alamat}</td><td>Tahun Pelajaran</td><td>:</td><td>${conf.thn}</td></tr></table><div class="header-separator"></div></div>`;
            const titleHTML = `<h1 class="dinas-title">LAPORAN HASIL BELAJAR</h1>`;
            
            const createSheet = (isFirst) => {
                const d = document.createElement('div'); 
                d.className = 'sheet sheet-dinas';
                d.innerHTML = headerHTML + (isFirst ? titleHTML : '') + '<div class="content-body"></div>' + `<div class="dinas-footer"><span>${conf.kelas} | ${toTitleCase(siswa.Nama)} | ${siswa.NIS||'-'}</span><span class="pg-num">Halaman 1</span></div>`;
                return d;
            };

            let curSheet = createSheet(true);
            if(measureContainer) measureContainer.appendChild(curSheet);
            let curBody = curSheet.querySelector('.content-body');
            pages.push(curSheet);

            const appendBlock = (html) => {
                const w = document.createElement('div'); w.innerHTML = html;
                curBody.appendChild(w);
                if(curBody.scrollHeight > curBody.clientHeight) {
                    curBody.removeChild(w); 
                    pageNum++;
                    curSheet = createSheet(false); 
                    curBody = curSheet.querySelector('.content-body');
                    if(measureContainer) measureContainer.appendChild(curSheet);
                    pages.push(curSheet);
                    curBody.appendChild(w); 
                }
            };

            const appendTable = (head, rows) => {
                let tbl = document.createElement('table'); tbl.className = 'dinas-table';
                tbl.innerHTML = `<thead>${head}</thead><tbody></tbody>`;
                curBody.appendChild(tbl); let tbody = tbl.querySelector('tbody');
                
                if(curBody.scrollHeight > curBody.clientHeight) {
                    curBody.removeChild(tbl); 
                    pageNum++;
                    curSheet = createSheet(false); curBody = curSheet.querySelector('.content-body');
                    if(measureContainer) measureContainer.appendChild(curSheet);
                    pages.push(curSheet);
                    tbl = document.createElement('table'); tbl.className = 'dinas-table'; tbl.innerHTML = `<thead>${head}</thead><tbody></tbody>`;
                    curBody.appendChild(tbl); tbody = tbl.querySelector('tbody');
                }

                rows.forEach(r => {
                    const t = document.createElement('tbody'); t.innerHTML = r; const tr = t.firstElementChild;
                    tbody.appendChild(tr);
                    if(curBody.scrollHeight > curBody.clientHeight) {
                        tbody.removeChild(tr);
                        pageNum++;
                        curSheet = createSheet(false); curBody = curSheet.querySelector('.content-body');
                        if(measureContainer) measureContainer.appendChild(curSheet);
                        pages.push(curSheet);
                        tbl = document.createElement('table'); tbl.className = 'dinas-table'; tbl.innerHTML = `<thead>${head}</thead><tbody></tbody>`;
                        curBody.appendChild(tbl); tbody = tbl.querySelector('tbody'); tbody.appendChild(tr);
                    }
                });
            };

            appendBlock(`<h3 class="dinas-sub">A. Intrakurikuler</h3>`);
            appendTable(`<tr><th width="5%">No</th><th width="35%">Mata Pelajaran</th><th width="10%">Nilai Akhir</th><th>Capaian Kompetensi</th></tr>`, [
                row(1, "Pendidikan Agama Islam dan Budi Pekerti", siswa.PAI, siswa.des_PAI), row(2, "Pendidikan Pancasila", siswa.Pkn, siswa.des_Pkn), row(3, "Bahasa Indonesia", siswa.Indo, siswa.des_indo), row(4, "Matematika (Umum)", siswa.Math, siswa.des_Math), row(5, "Ilmu Pengetahuan Alam (IPA)", siswa.IPA, siswa.des_IPA), row(6, "Ilmu Pengetahuan Sosial (IPS)", siswa.IPS, siswa.des_IPS), row(7, "Bahasa Inggris", siswa.English, siswa.des_english), row(8, "Seni dan Budaya", siswa.NILAI_SBK, siswa.des_SBK), row(9, "Pendidikan Jasmani, Olahraga, dan Kesehatan", siswa.Sport, siswa.des_Sport), row(10, "Informatika", siswa.ICT, siswa.des_ICT), row(11, "Bahasa Jawa", siswa.jawa, siswa.des_jawa)
            ]);
            appendBlock(`<h3 class="dinas-sub">B. Kokurikuler</h3><table class="dinas-table"><tr><th>Deskripsi</th></tr><tr><td style="height:60px; text-align:justify;">${siswa['Deskripsi Kokurikuler']||'-'}</td></tr></table>`);
            appendBlock(`<h3 class="dinas-sub">C. Ekstrakurikuler</h3><table class="dinas-table"><tr><th>No</th><th>Kegiatan</th><th>Predikat</th><th>Keterangan</th></tr><tr><td class="cell-center">1</td><td class="cell-left"><span class="toggle-text" onclick="toggleStrike(this)">Kepramukaan</span> / <span class="toggle-text" onclick="toggleStrike(this)">PMR</span></td><td class="cell-center bold">${siswa['Predikat']||'-'}</td><td class="cell-leftextra">${siswa['Deskripsi PRAMUKA / PMR']||'-'}</td></tr><tr><td class="cell-center">2</td><td class="cell-left">${siswa.NAMA_SD||'Self Dev'}</td><td class="cell-center bold">${siswa.predikat||'-'}</td><td class="cell-leftextra">${siswa.des_SD||'-'}</td></tr></table>`);
            appendBlock(`<h3 class="dinas-sub">D. Ketidakhadiran</h3><table class="dinas-table" style="width:50%"><tr><td class="cell-left">Sakit</td><td class="cell-left">: ${sakit} hari</td></tr><tr><td class="cell-left">Izin</td><td class="cell-left">: ${izin} hari</td></tr><tr><td class="cell-left">Tanpa Ket.</td><td class="cell-left">: ${alpha} hari</td></tr></table>`);
            appendBlock(`<h3 class="dinas-sub">E. Catatan Wali Kelas</h3><div class="catatan-box">${siswa['CATATAN WALAS']||'-'}</div>`);
            
            appendBlock(`
            <div class="signature-container">
                <div class="signature-grid">
                    <div class="sig-box">
                        <p>Mengetahui,<br>Orang Tua/Wali</p>
                        <div class="space-sign" style="position:relative;"></div>
                        <p>(...................)</p>
                    </div>
                    <div class="sig-box">
                        <p>${conf.tgl}<br>Wali Kelas,</p>
                        <div class="space-sign" style="position:relative;">${getSigHTML('dinas')}</div>
                        <p><u><strong>${conf.wali}</strong></u><br>NIP. ${conf.nip}</p>
                    </div>
                    <div class="sig-box-center">
                        <p>Mengetahui,<br>Kepala Sekolah</p>
                        <div class="space-sign" style="height:50px; position:relative;">
                            <div style="position:absolute; width:100%; height:100%; display:flex; align-items:center; justify-content:center;">
                                ${getSigHTML('kepsek')}
                            </div>
                        </div>
                        <p><u><strong>${conf.kepsek}</strong></u><br>NIP. ${conf.nipKepsek}</p>
                    </div>
                </div>
            </div>`);

            pages.forEach((p, i) => { p.querySelector('.pg-num').innerText = `Halaman ${i + 1}`; });
            return pages;
        }

        // ==========================================
        //  GENERATOR ILA PAGES DENGAN PERBAIKAN SUMMARY
        // ==========================================
        function generateILAPages(siswa, conf) {
            const pages = [];
            const dim1 = ilaStructure[0], dim2 = ilaStructure[1];

            const getHeader = () => `<div class="ila-h1">International Leadership Al Abidin Report</div><div class="ila-info-container"><div class="ila-info-col"><table class="ila-info-table"><tr><td width="70">School</td><td width="10">:</td><td class="val">${conf.sekolah}</td></tr><tr><td>Number</td><td>:</td><td class="val">${safeVal(siswa['No'])}</td></tr></table></div><div class="ila-info-col"><table class="ila-info-table"><tr><td width="70">Name</td><td width="10">:</td><td class="val">${toTitleCase(siswa['Nama Siswa'] || siswa.Nama)}</td></tr><tr><td>Class</td><td>:</td><td class="val">${conf.kelas}</td></tr></table></div></div>`;
            const getFooter = (p) => `<div class="dinas-footer"><span>${conf.kelas} | ${toTitleCase(siswa['Nama Siswa'] || siswa.Nama)}</span><span>Page ${p}</span></div>`;
            
            const renderPartial = (val, start, end, showTitle = true) => {
                let h = showTitle ? `<div class="ila-val-title">${val.name}</div>` : "";
                h += `<div class="ila-table-container"><table class="ila-table"><thead><tr><th style="width:50%;">Indicator</th><th class="col-score">Parents</th><th class="col-score">School</th><th class="col-score">Student</th></tr></thead><tbody>`;
                val.cats.slice(start, end).forEach(cat => {
                    h += `<tr class="row-category"><td colspan="4">${cat.code} ${cat.title}</td></tr>`;
                    cat.inds.forEach(ind => {
                        h += `<tr><td class="indicator-text">${ind.c}. ${ind.t}</td><td class="col-score">${safeVal(getScore(siswa, 'Ortu', ind.c))}</td><td class="col-score">${safeVal(getScore(siswa, 'Guru', ind.c))}</td><td class="col-score">${safeVal(getScore(siswa, 'Siswa', ind.c))}</td></tr>`;
                    });
                });
                return h + `</tbody></table></div>`;
            };

            const createP = (n, content) => {
                const d = document.createElement('div'); d.className = 'sheet sheet-ila';
                d.innerHTML = getHeader() + content + '<div class="content-body"></div>' + getFooter(n);
                return d;
            };

            // HAL 1 - TETAP PAKAI DESKRIPSI LAMA (TIDAK BERUBAH)
            const scoreCard = `<div class="scoring-card"><div class="scoring-title">Grading Scale Description</div><div class="scoring-grid">${[5,4,3,2,1].map(v=>`<div class="score-box"><div class="sb-head">${v}</div><div class="sb-body"><span class="sb-label">${getPredikatShort(v)}</span>${gradingDesc[v]}</div></div>`).join('')}</div></div>`;
            pages.push(createP(1, scoreCard + `<div class="ila-dim-title">${dim1.dim}</div>` + renderPartial(dim1.vals[0], 0, 4)));
            // HAL 2
            pages.push(createP(2, renderPartial(dim1.vals[0], 4, 6) + renderPartial(dim1.vals[1], 0, 2, true) + renderPartial(dim1.vals[2], 0, 1, true)));
            // HAL 3
            pages.push(createP(3, renderPartial(dim1.vals[2], 1, 4, true) + renderPartial(dim1.vals[3], 0, 2, true) + `<div class="ila-dim-title" style="margin-top:20px;">${dim2.dim}</div>` + renderPartial(dim2.vals[0], 0, 1, true)));
            // HAL 4
            pages.push(createP(4, renderPartial(dim2.vals[0], 1, 3, true) + renderPartial(dim2.vals[1], 0, 3, true) + renderPartial(dim2.vals[2], 0, 2, true)));
            // HAL 5
            pages.push(createP(5, renderPartial(dim2.vals[3], 0, 3, true)));
            // HAL 6 - SUMMARY DENGAN DESKRIPSI BARU
            const d6 = document.createElement('div'); d6.className = 'sheet sheet-ila';
            let resH = getHeader() + `<div class="resume-page-header"><div class="resume-title-main">Achievement Summary</div></div>`;
            
            ilaStructure.forEach(d => {
                const cleanDim = d.dim.replace(/^[0-9.]+\s*/, '');
                resH += `<div class="resume-section"><div class="resume-dim-header">${cleanDim}</div><table class="resume-table"><thead><tr><th width="30%">Value</th><th width="15%">Average</th><th>Criteria Description</th></tr></thead><tbody>`;
                
                d.vals.forEach(v => {
                    const avg = calculateValueAverage(siswa, v);
                    // PERUBAHAN: Gunakan fungsi baru untuk summary
                    const desc = getDescriptionFromAverageForSummary(avg);
                    
                    resH += `<tr><td class="bold">${v.name}</td><td class="center bold">${avg}</td><td class="resume-desc">${desc}</td></tr>`;
                });
                resH += `</tbody></table></div>`;
            });
            
            resH += `<div class="ila-sig-section"><div class="ila-sig-box"><p>${conf.tgl}<br>Homeroom Teacher</p><div class="space-sign" style="height:60px; position:relative;">${getSigHTML('ila')}</div><p><u><strong>${conf.wali}</strong></u></p></div></div>`;
            d6.innerHTML = resH + getFooter(6);
            pages.push(d6);

            return pages;
        }

        // ==========================================
        //  BATCH PDF & ZIP GENERATION
        // ==========================================
        async function elementToImage(element) {
            const canvas = await html2canvas(element, {
                scale: 2,
                useCORS: true,
                logging: false,
                windowWidth: 210 * 3.7795275591, 
                windowHeight: 297 * 3.7795275591
            });
            return canvas.toDataURL('image/jpeg', 0.9);
        }

        async function generateBatchPDF(type) {
            const res = getDataAndConf(type);
            if(!res) { Swal.fire('Oops...', 'Silakan upload file leger terlebih dahulu!', 'warning'); return; }
            
            const btn = type === 'dinas' ? document.querySelector('#app-dinas .bg-green') : document.querySelector('#app-ila .bg-green');
            const progDiv = document.getElementById(type === 'dinas' ? 'progDinas' : 'progILA');
            const progFill = document.getElementById(type === 'dinas' ? 'fillDinas' : 'fillILA');
            const progText = document.getElementById(type === 'dinas' ? 'txtDinas' : 'txtILA');
            const hiddenDiv = document.getElementById('hidden-processing');
            
            btn.disabled = true; progDiv.style.display = 'block';

            try {
                const pdfDoc = await PDFLib.PDFDocument.create();
                const total = res.data.length;
                const A4_W = 595.28;
                const A4_H = 841.89;

                for (let i = 0; i < total; i++) {
                    const siswa = res.data[i];
                    
                    const pct = Math.round(((i+1)/total)*100);
                    progFill.style.width = pct + "%";
                    progText.innerText = `Mengonversi Data Siswa: ${i+1}/${total} (${siswa.Nama || siswa['Nama Siswa']})`;
                    await new Promise(r => setTimeout(r, 10)); 

                    hiddenDiv.innerHTML = '';
                    const pages = (type === 'dinas') 
                        ? generateDinasPages(siswa, res.conf, hiddenDiv) 
                        : generateILAPages(siswa, res.conf);

                    for (const pageEl of pages) {
                        const textContent = pageEl.innerText.trim();
                        const hasImages = pageEl.querySelectorAll('img').length > 0;
                        const hasTables = pageEl.querySelectorAll('table').length > 0;
                        
                        if (textContent.length < 5 && !hasImages && !hasTables) continue;

                        hiddenDiv.innerHTML = '';
                        hiddenDiv.appendChild(pageEl);

                        const imgData = await elementToImage(pageEl);
                        const img = await pdfDoc.embedJpg(imgData);
                        const page = pdfDoc.addPage([A4_W, A4_H]);
                        page.drawImage(img, { x: 0, y: 0, width: A4_W, height: A4_H });
                    }
                }

                progText.innerText = "Menyimpan File PDF...";
                const pdfBytes = await pdfDoc.save();
                const blob = new Blob([pdfBytes], { type: "application/pdf" });
                saveAs(blob, `Rapor ${type.toUpperCase()} ${res.conf.kelas}.pdf`);
                
                Swal.fire({ icon: 'success', title: 'Selesai!', text: 'File PDF berhasil diunduh.', timer: 2000 });

            } catch (err) {
                console.error(err);
                Swal.fire({ icon: 'error', title: 'Terjadi Kesalahan', text: err.message });
            } finally {
                hiddenDiv.innerHTML = '';
                btn.disabled = false; progDiv.style.display = 'none';
            }
        }

        async function generateBatchZIP(type) {
            const res = getDataAndConf(type);
            if(!res) { Swal.fire('Oops...', 'Upload file dulu!', 'warning'); return; }

            const btn = type === 'dinas' ? document.querySelector('#app-dinas .bg-orange') : document.querySelector('#app-ila .bg-orange');
            const progDiv = document.getElementById(type === 'dinas' ? 'progDinas' : 'progILA');
            const progFill = document.getElementById(type === 'dinas' ? 'fillDinas' : 'fillILA');
            const progText = document.getElementById(type === 'dinas' ? 'txtDinas' : 'txtILA');
            const hiddenDiv = document.getElementById('hidden-processing');
            
            btn.disabled = true; progDiv.style.display = 'block';

            const zip = new JSZip();
            const total = res.data.length;
            const A4_W = 595.28;
            const A4_H = 841.89;

            try {
                for (let i = 0; i < total; i++) {
                    const siswa = res.data[i];
                    const name = siswa.Nama || siswa['Nama Siswa'];
                    const no = siswa['No'] || (i+1);
                    
                    progFill.style.width = Math.round(((i+1)/total)*100) + "%";
                    progText.innerText = `Memproses ZIP: ${name} (${i+1}/${total})`;
                    await new Promise(r => setTimeout(r, 10));

                    const pdfDoc = await PDFLib.PDFDocument.create();
                    hiddenDiv.innerHTML = '';
                    const pages = (type === 'dinas') 
                        ? generateDinasPages(siswa, res.conf, hiddenDiv) 
                        : generateILAPages(siswa, res.conf);

                    for (const pageEl of pages) {
                        const textContent = pageEl.innerText.trim();
                        const hasImages = pageEl.querySelectorAll('img').length > 0;
                        const hasTables = pageEl.querySelectorAll('table').length > 0;
                        if (textContent.length < 5 && !hasImages && !hasTables) continue;

                        hiddenDiv.innerHTML = '';
                        hiddenDiv.appendChild(pageEl);

                        const imgData = await elementToImage(pageEl);
                        const img = await pdfDoc.embedJpg(imgData);
                        const page = pdfDoc.addPage([A4_W, A4_H]);
                        page.drawImage(img, { x: 0, y: 0, width: A4_W, height: A4_H });
                    }

                    const pdfBytes = await pdfDoc.save();
                    zip.file(`${no} ${type.toUpperCase()} ${name}.pdf`, pdfBytes);
                }

                progText.innerText = "Mengompres ZIP...";
                const content = await zip.generateAsync({type:"blob"});
                saveAs(content, `Rapor ${type.toUpperCase()} ${res.conf.kelas} Per Siswa.zip`);
                Swal.fire({ icon: 'success', title: 'Selesai!', text: 'File ZIP berhasil diunduh.', timer: 2000 });

            } catch (err) {
                console.error(err);
                Swal.fire({ icon: 'error', title: 'Gagal', text: err.message });
            } finally {
                hiddenDiv.innerHTML = '';
                btn.disabled = false; progDiv.style.display = 'none';
            }
        }

        // ==========================================
        //  HELPER FUNCTIONS
        // ==========================================
        function toggleStrike(el) { el.classList.toggle('is-crossed'); }
    </script>
</body>
</html>
